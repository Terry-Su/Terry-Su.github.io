<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="description" content=" 搞懂React源码系列-React Diff原理 时隔2年，重新看React源码，很多以前不理解的内容现在都懂了。本文将用实际案例结合相关React源码，集中讨论React Diff原理。使用当前最新React版本：16.13.1。

另外，今年将写... (苏溪云的博客)">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>搞懂React源码系列-React Diff原理(苏溪云的博客)</title>
    <style>
html,body,#root {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
      </style>
    <style data-styled="hLslGA CETdD dnzreb jJwZBa cvEDsD jPLDlV byAIoc NQCry jXXWzP fHKJdy  emoJPF hxfRZv iTejwj bfMZoa jYTulZ" data-styled-version="4.3.2">
/* sc-component-id: sc-global-1634256650 */
.markdown-body .highlight pre,.markdown-body pre{background:hsl(24,39%,99%)!important;} .markdown-body .highlight pre .token.operator,.markdown-body pre .token.operator{background:none;} .markdown-body iframe{width:100%;height:300px;border:none;} .markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom;} .markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px;} .markdown-body .anchor:focus{outline:none;} .markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden;} .markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{-webkit-text-decoration:none;text-decoration:none;} .markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible;} .markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;line-height:1.5;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial, sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-size:16px;line-height:1.5;word-wrap:break-word;} .markdown-body .pl-c{color:#6a737d;} .markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5;} .markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1;} .markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e;} .markdown-body .pl-ent{color:#22863a;} .markdown-body .pl-k{color:#d73a49;} .markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62;} .markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209;} .markdown-body .pl-bu{color:#b31d28;} .markdown-body .pl-ii{background-color:#b31d28;color:#fafbfc;} .markdown-body .pl-c2{background-color:#d73a49;color:#fafbfc;} .markdown-body .pl-c2:before{content:"^M";} .markdown-body .pl-sr .pl-cce{color:#22863a;font-weight:700;} .markdown-body .pl-ml{color:#735c0f;} .markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{color:#005cc5;font-weight:700;} .markdown-body .pl-mi{color:#24292e;font-style:italic;} .markdown-body .pl-mb{color:#24292e;font-weight:700;} .markdown-body .pl-md{background-color:#ffeef0;color:#b31d28;} .markdown-body .pl-mi1{background-color:#f0fff4;color:#22863a;} .markdown-body .pl-mc{background-color:#ffebda;color:#e36209;} .markdown-body .pl-mi2{background-color:#005cc5;color:#f6f8fa;} .markdown-body .pl-mdr{color:#6f42c1;font-weight:700;} .markdown-body .pl-ba{color:#586069;} .markdown-body .pl-sg{color:#959da5;} .markdown-body .pl-corl{color:#032f62;-webkit-text-decoration:underline;text-decoration:underline;} .markdown-body details{display:block;} .markdown-body summary{display:list-item;} .markdown-body a{background-color:transparent;} .markdown-body a:active,.markdown-body a:hover{outline-width:0;} .markdown-body strong{font-weight:inherit;font-weight:bolder;} .markdown-body h1{font-size:2em;margin:0.67em 0;} .markdown-body img{border-style:none;} .markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em;white-space:pre-wrap!important;white-space:-moz-pre-wrap!important;white-space:-pre-wrap!important;white-space:-o-pre-wrap!important;word-wrap:break-word!important;} .markdown-body hr{box-sizing:content-box;height:0;overflow:visible;} .markdown-body input{font:inherit;margin:0;} .markdown-body input{overflow:visible;} .markdown-body [type="checkbox"]{box-sizing:border-box;padding:0;} .markdown-body *{box-sizing:border-box;} .markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit;} .markdown-body a{color:#0366d6;-webkit-text-decoration:none;text-decoration:none;} .markdown-body a:hover{-webkit-text-decoration:underline;text-decoration:underline;} .markdown-body strong{font-weight:600;} .markdown-body hr{background:0 0;border:0;border-bottom:1px solid #dfe2e5;height:0;margin:15px 0;overflow:hidden;} .markdown-body hr:before{content:"";display:table;} .markdown-body hr:after{clear:both;content:"";display:table;} .markdown-body table{border-collapse:collapse;border-spacing:0;} .markdown-body td,.markdown-body th{padding:0;} .markdown-body details summary{cursor:pointer;} .markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-bottom:0;margin-top:0;} .markdown-body h1{font-size:32px;} .markdown-body h1,.markdown-body h2{font-weight:600;} .markdown-body h2{font-size:24px;} .markdown-body h3{font-size:20px;} .markdown-body h3,.markdown-body h4{font-weight:600;} .markdown-body h4{font-size:16px;} .markdown-body h5{font-size:14px;} .markdown-body h5,.markdown-body h6{font-weight:600;} .markdown-body h6{font-size:12px;} .markdown-body p{margin-bottom:10px;margin-top:0;} .markdown-body blockquote{margin:0;} .markdown-body ol,.markdown-body ul{margin-bottom:0;margin-top:0;padding-left:0;} .markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman;} .markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha;} .markdown-body dd{margin-left:0;} .markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier, monospace;font-size:12px;} .markdown-body pre{margin-bottom:0;margin-top:0;} .markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{-webkit-appearance:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;margin:0;} .markdown-body .border{border:1px solid #e1e4e8 !important;} .markdown-body .border-0{border:0 !important;} .markdown-body .border-bottom{border-bottom:1px solid #e1e4e8 !important;} .markdown-body .rounded-1{border-radius:3px !important;} .markdown-body .bg-white{background-color:#fff !important;} .markdown-body .bg-gray-light{background-color:#fafbfc !important;} .markdown-body .text-gray-light{color:#6a737d !important;} .markdown-body .mb-0{margin-bottom:0 !important;} .markdown-body .my-2{margin-bottom:8px !important;margin-top:8px !important;} .markdown-body .pl-0{padding-left:0 !important;} .markdown-body .py-0{padding-bottom:0 !important;padding-top:0 !important;} .markdown-body .pl-1{padding-left:4px !important;} .markdown-body .pl-2{padding-left:8px !important;} .markdown-body .py-2{padding-bottom:8px !important;padding-top:8px !important;} .markdown-body .pl-3,.markdown-body .px-3{padding-left:16px !important;} .markdown-body .px-3{padding-right:16px !important;} .markdown-body .pl-4{padding-left:24px !important;} .markdown-body .pl-5{padding-left:32px !important;} .markdown-body .pl-6{padding-left:40px !important;} .markdown-body .f6{font-size:12px !important;} .markdown-body .lh-condensed{line-height:1.25 !important;} .markdown-body .text-bold{font-weight:600 !important;} .markdown-body:before{content:"";display:table;} .markdown-body:after{clear:both;content:"";display:table;} .markdown-body > :first-child{margin-top:0 !important;} .markdown-body > :last-child{margin-bottom:0 !important;} .markdown-body a:not([href]){color:inherit;-webkit-text-decoration:none;text-decoration:none;} .markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-bottom:16px;margin-top:0;} .markdown-body hr{background-color:#e1e4e8;border:0;height:0.25em;margin:24px 0;padding:0;} .markdown-body blockquote{border-left:0.25em solid #dfe2e5;color:#6a737d;padding:0 1em;} .markdown-body blockquote > :first-child{margin-top:0;} .markdown-body blockquote > :last-child{margin-bottom:0;} .markdown-body kbd{background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5;color:#444d56;display:inline-block;font-size:11px;line-height:10px;padding:3px 5px;vertical-align:middle;} .markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:600;line-height:1.25;margin-bottom:16px;margin-top:24px;} .markdown-body h1{font-size:2em;} .markdown-body h1,.markdown-body h2{border-bottom:1px solid #eaecef;padding-bottom:0.3em;} .markdown-body h2{font-size:1.5em;} .markdown-body h3{font-size:1.25em;} .markdown-body h4{font-size:1em;} .markdown-body h5{font-size:0.875em;} .markdown-body h6{color:#6a737d;font-size:0.85em;} .markdown-body ol,.markdown-body ul{padding-left:2em;} .markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-bottom:0;margin-top:0;} .markdown-body li{word-wrap:break-all;} .markdown-body li > p{margin-top:16px;} .markdown-body li + li{margin-top:0.25em;} .markdown-body dl{padding:0;} .markdown-body dl dt{font-size:1em;font-style:italic;font-weight:600;margin-top:16px;padding:0;} .markdown-body dl dd{margin-bottom:16px;padding:0 16px;} .markdown-body table{display:block;overflow:auto;width:100%;} .markdown-body table th{font-weight:600;} .markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:6px 13px;} .markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1;} .markdown-body table tr:nth-child(2n){background-color:#f6f8fa;} .markdown-body img{background-color:#fff;box-sizing:content-box;max-width:100%;} .markdown-body img[align="right"]{padding-left:20px;} .markdown-body img[align="left"]{padding-right:20px;} .markdown-body code{background-color:rgba(27,31,35,0.05);border-radius:3px;font-size:85%;margin:0;padding:0.2em 0.4em;} .markdown-body pre{word-wrap:normal;} .markdown-body pre > code{background:0 0;border:0;font-size:100%;margin:0;padding:0;word-break:normal;} .markdown-body .highlight{margin-bottom:16px;} .markdown-body .highlight pre{margin-bottom:0;word-break:normal;} .markdown-body .highlight pre,.markdown-body pre{border-radius:3px;font-size:85%;line-height:1.45;overflow:auto;padding:16px;} .markdown-body pre code{border:0;display:inline;line-height:inherit;margin:0;max-width:auto;overflow:visible;padding:0;word-wrap:normal;} .markdown-body .commit-tease-sha{color:#444d56;display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier, monospace;font-size:90%;} .markdown-body .blob-wrapper{border-bottom-left-radius:3px;border-bottom-right-radius:3px;overflow-x:auto;overflow-y:hidden;} .markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto;} .markdown-body .blob-num{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;color:rgba(27,31,35,0.3);cursor:pointer;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier, monospace;font-size:12px;line-height:20px;min-width:50px;padding-left:10px;padding-right:10px;text-align:right;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:top;white-space:nowrap;width:1%;} .markdown-body .blob-num:hover{color:rgba(27,31,35,0.6);} .markdown-body .blob-num:before{content:attr(data-line-number);} .markdown-body .blob-code{line-height:20px;padding-left:10px;padding-right:10px;position:relative;vertical-align:top;} .markdown-body .blob-code-inner{color:#24292e;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier, monospace;font-size:12px;overflow:visible;white-space:pre;word-wrap:normal;} .markdown-body .pl-token.active,.markdown-body .pl-token:hover{background:#ffea7f;cursor:pointer;} .markdown-body kbd{background-color:#fafbfc;border:1px solid #d1d5da;border-bottom-color:#c6cbd1;border-radius:3px;box-shadow:inset 0 -1px 0 #c6cbd1;color:#444d56;display:inline-block;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier, monospace;line-height:10px;padding:3px 5px;vertical-align:middle;} .markdown-body :checked + .radio-label{border-color:#0366d6;position:relative;z-index:1;} .markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1;} .markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2;} .markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3;} .markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4;} .markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5;} .markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6;} .markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7;} .markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8;} .markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9;} .markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10;} .markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11;} .markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12;} .markdown-body .task-list-item{list-style-type:none;} .markdown-body .task-list-item + .task-list-item{margin-top:3px;} .markdown-body .task-list-item input{margin:0 0.2em 0.25em -1.6em;vertical-align:middle;} .markdown-body hr{border-bottom-color:#eee;} .markdown-body .pl-0{padding-left:0 !important;} .markdown-body .pl-1{padding-left:4px !important;} .markdown-body .pl-2{padding-left:8px !important;} .markdown-body .pl-3{padding-left:16px !important;} .markdown-body .pl-4{padding-left:24px !important;} .markdown-body .pl-5{padding-left:32px !important;} .markdown-body .pl-6{padding-left:40px !important;} .markdown-body .pl-7{padding-left:48px !important;} .markdown-body .pl-8{padding-left:64px !important;} .markdown-body .pl-9{padding-left:80px !important;} .markdown-body .pl-10{padding-left:96px !important;} .markdown-body .pl-11{padding-left:112px !important;} .markdown-body .pl-12{padding-left:128px !important;} code[class*="language-"],pre[class*="language-"]{color:black;background:none;text-shadow:0 1px white;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;} pre[class*="language-"]::-moz-selection,pre[class*="language-"] ::-moz-selection,code[class*="language-"]::-moz-selection,code[class*="language-"] ::-moz-selection{text-shadow:none;background:#b3d4fc;} pre[class*="language-"]::selection,pre[class*="language-"] ::selection,code[class*="language-"]::selection,code[class*="language-"] ::selection{text-shadow:none;background:#b3d4fc;} @media print{code[class*="language-"],pre[class*="language-"]{text-shadow:none;}} pre[class*="language-"]{padding:1em;margin:.5em 0;overflow:auto;} :not(pre) > code[class*="language-"],pre[class*="language-"]{background:#f5f2f0;} :not(pre) > code[class*="language-"]{padding:.1em;border-radius:.3em;white-space:normal;} .token.comment,.token.prolog,.token.doctype,.token.cdata{color:slategray;} .token.punctuation{color:#999;} .namespace{opacity:.7;} .token.property,.token.tag,.token.boolean,.token.number,.token.constant,.token.symbol,.token.deleted{color:#905;} .token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.inserted{color:#690;} .token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string{color:#9a6e3a;background:hsla(0,0%,100%,.5);} .token.atrule,.token.attr-value,.token.keyword{color:#07a;} .token.function,.token.class-name{color:#DD4A68;} .token.regex,.token.important,.token.variable{color:#e90;} .token.important,.token.bold{font-weight:bold;} .token.italic{font-style:italic;} .token.entity{cursor:help;}
/* sc-component-id: sc-htpNat */
.fHKJdy{width:100%;height:100%;} .fHKJdy .markdown-body{width:100%;height:100%;}
/* sc-component-id: sc-ifAKCX */
.jYTulZ{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:70px;background:#182633;} .jYTulZ > .contentWrapper{color:rgba(255,255,255,0.5);font-size:14px;} .jYTulZ > .contentWrapper > .authorLink{margin:0 6px;color:#19affc;}
/* sc-component-id: sc-EHOje */
.cvEDsD{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:space-around;-webkit-justify-content:space-around;-ms-flex-pack:space-around;justify-content:space-around;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:"100%";height:118px;}
/* sc-component-id: sc-bZQynM */
.jPLDlV{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:0;} .jPLDlV > .logoTitle{margin:10px;font-size:18px;font-weight:bold;-webkit-letter-spacing:0px;-moz-letter-spacing:0px;-ms-letter-spacing:0px;letter-spacing:0px;color:#555;}
/* sc-component-id: sc-gzVnrw */
.byAIoc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;} @media (max-width:576px){.byAIoc{width:100%;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}}
/* sc-component-id: sc-htoDjs */
.NQCry{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;color:#aaa;-webkit-letter-spacing:1px;-moz-letter-spacing:1px;-ms-letter-spacing:1px;letter-spacing:1px;} .NQCry:hover{color:#888;} @media (max-width:576px){.NQCry{-webkit-flex:1;-ms-flex:1;flex:1;}} .NQCry a{font-size:16px;color:unset;-webkit-text-decoration:none;text-decoration:none;margin:0 10px;} @media (max-width:576px){.NQCry a{margin:0;}}
/* sc-component-id: sc-global-468606897 */
html,body{width:100%;height:100%;margin:0;padding:0;} body{font-size:'16px';font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;background:hsl(27,39%,95%);} @media (max-width:576px){body{box-sizing:border-box;padding:20px;}}
/* sc-component-id: sc-gZMcBi */
.bfMZoa{width:"100%";} .bfMZoa .comment-box-wrapper{margin-bottom:50px;}
/* sc-component-id: sc-gqjmRU */
.jXXWzP > .wrapper{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;} .jXXWzP > .wrapper > .contentWrapper{width:100%;max-width:700px;} .jXXWzP > .wrapper > .contentWrapper > .titleWrapper{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:42px;font-weight:bold;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;} .jXXWzP > .wrapper > .contentWrapper > .isAutoTranslatedWrapper{margin:40px 0 0 0;} .jXXWzP > .wrapper > .contentWrapper > .markdownWrapper{margin:40px 0 0 0;}
/* sc-component-id: sc-VigVT */
.emoJPF{margin-top:80px;padding-top:80px;border-top:1px solid #ddd;} .emoJPF > .imageWrapper{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;} .emoJPF > .imageWrapper > img{max-width:100%;}
/* sc-component-id: sc-jTzLTM */
.hxfRZv{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;margin:40px 0 0 0;} .hxfRZv > .categoryWrapper{margin:10px 0 0 0;} .hxfRZv > .reprintingNoteWrapper{margin:10px 0 0 0;}
/* sc-component-id: sc-fjdhpX */
.iTejwj{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;width:100%;margin:80px 0 0 0;padding:40px 0;} .iTejwj > .wrapper{max-width:700px;} .iTejwj > .wrapper > .disqusCommentWrapper{padding:0;}
/* sc-component-id: sc-ckVGcZ */
.hLslGA{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}
/* sc-component-id: sc-jKJlTe */
.CETdD{visibility:visible;}
/* sc-component-id: sc-hMqMXs */
.dnzreb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}
/* sc-component-id: sc-kEYyzF */
.jJwZBa{visibility:visible;}</style>
  </head>
  <body>
    <div id="root"><div style="width:100%;height:100%"><div style="width:100%;height:100%"><div style="position:absolute;right:40px;top:20px"><div><div></div></div></div><div class="sc-EHOje cvEDsD"><span><a href="/cn/" style="color:unset;text-decoration:none"><div class="sc-bZQynM jPLDlV"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABGCAYAAAA6hjFpAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQTdGMTE3NDA3MjA2ODExODA4MzgzOEY5RkU5QUQyOSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo1NzdFMEUxN0M2RDYxMUU5QkUyREI4MzA0MEM5OUU5MiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo1NzdFMEUxNkM2RDYxMUU5QkUyREI4MzA0MEM5OUU5MiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MDM4MDExNzQwNzIwNjgxMTgyMkFCQUIwNDJFMjU2RkUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RkE3RjExNzQwNzIwNjgxMTgwODM4MzhGOUZFOUFEMjkiLz4gPC9yZGY6RGVzY3Jp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" height="24" class="logo"/><span class="logoTitle">苏溪云</span></div></a></span><div class="sc-gzVnrw byAIoc"><div class="sc-htoDjs NQCry"><a href="/cn/" style="color:unset;text-decoration:none">所有文章</a></div><div class="sc-htoDjs NQCry"><a href="/cn/about" style="color:unset;text-decoration:none">关于作者</a></div><div class="sc-htoDjs NQCry"><a href="https://github.com/Terry-Su/blogs-cn">GITHUB</a></div></div></div><div style="margin:50px 0 0 0;min-height:calc(100% - 118px - 50px)"><div class="sc-gqjmRU jXXWzP"><div class="wrapper"><div class="contentWrapper"><span class="titleWrapper">搞懂React源码系列-React Diff原理</span><div class="markdownWrapper"><div class="markdown-body sc-htpNat fHKJdy"><div><div><div><p>时隔2年，重新看React源码，很多以前不理解的内容现在都懂了。本文将用实际案例结合相关React源码，集中讨论React Diff原理。使用当前最新React版本：<code>16.13.1</code>。</p><p>另外，今年将写一个“搞懂React源码系列”，把React<strong>最核心内容</strong>用最通俗易懂地方式讲清楚。2020年搞懂React源码系列：</p><ul><li><p>React Diff原理</p></li><li><p>React 调度原理</p></li><li><p>搭建阅读React源码环境-支持所有版本断点调试</p></li><li><p>React Hooks原理</p></li></ul><p>在讨论Diff算法前，有必要先介绍React Fiber，因为React源码中各种实现都是基于Fiber，包括Diff算法。当然，熟悉React Fiber的朋友可跳过Fiber介绍。</p><h2>Fiber简介</h2><p>Fiber并不复杂，但如果要<a href="https://zhuanlan.zhihu.com/p/57346388">全面理解</a>，还是得花好一段时间。本文主题是diff原理，所以这里仅简单介绍下Fiber。</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/fiber.png"/></p><p>Fiber是一个抽象的节点对象，每个对象可能有子Fiber(child)和相邻Fiber(child)和父Fiber(return),React使用链表的形式将所有Fiber节点连接，形成链表树。</p><p>Fiber还有副作用标签(effectTag)，比如替换Placement(替换)和Deletion(删除)，用于之后更新DOM。</p><p>值得注意的是，React diff中，除了fiber，还用到了基础的<a href="https://reactjs.org/docs/glossary.html#elements">React元素对象</a>（如： 将<code>&lt;div&gt;foo&lt;/div&gt;</code>编译后生成的对象: <code>{ type: &#x27;div&#x27;, props: { children: &#x27;foo&#x27; } }</code> ）。</p><h2>Diff 过程</h2><p>React源码中，关于diff要从<code>reconcileChildren(...)</code>说起。</p><p>总流程：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-main.svg"/></p><p>流程图中, 显示源码中用到的函数名，省略复杂参数。“新内容”即被比较的新内容，它可能是三种类型：</p><ul><li><p>对象： React元素</p></li><li><p>字符串或数字： 文本</p></li><li><p>数组：数组元素可能是React元素或文本</p></li></ul><h2>新内容为React元素</h2><p>我们先以新内容为React元素为例，全面的调试一遍代码，将之后会重复用到的方法在此步骤中讲解，同时以一张流程图作为总结。</p><p>案例：</p><pre><code class="language-js">function SingleElementDifferentTypeChildA() { return &lt;h1&gt;A&lt;/h1&gt; }

function SingleElementDifferentTypeChildB() { return &lt;h2&gt;B&lt;/h2&gt; }

function SingleElementDifferentType() {

 const [ showingA, setShowingA ] = useState( true ) 

 useEffect( () =&gt; {

  setTimeout( () =&gt; setShowingA( false ), 1000 )

 } )

 return showingA ? &lt;SingleElementDifferentTypeChildA/&gt; : &lt;SingleElementDifferentTypeChildB/&gt;

}

ReactDOM.render( &lt;SingleElementDifferentType/&gt;, document.getElementById(&#x27;container&#x27;) )
</code></pre><p>从第一步<code>reconcileChildren(...)</code>开始调试代码，无需关注与diff不相关的内容，比如<code>renderExpirationTime</code>。左侧调试面板可看到对应变量的类型。</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/1.png"/></p><p>此处:</p><ul><li><p><code>workInProgress</code>: 父级Fiber</p></li><li><p><code>current.child</code>: 处于比较中的旧内容对应fiber</p></li><li><p><code>nextChildren</code>: 即处于比较中的新内容, 为React元素，其类型为对象。</p></li></ul><p><strong>在Diff时</strong>，比较中的<strong>旧内容为Fiber</strong>,而比较中的<strong>新内容为React元素、文本或数组</strong>。其实从这一步已经可以看出，React官网的<a href="https://reactjs.org/docs/reconciliation.html#the-diffing-algorithm">diff算法说明</a>和实际代码是实现差别较大。</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/2.png"/></p><p>因为新内容为对象，所以继续执行<code>reconcileSingleElement(...)</code>和<code>placeSingleChild(...)</code>。</p><p>我们先看<code>placeSingleChild(...)</code>：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/3.png"/></p><p><code>placeSingleChild(...)</code>的作用很简单，给differ后的Fiber添加副作用标签：Placement（替换），表明在之后需要将旧Fiber对应的DOM元素进行替换。</p><p>继续看 <code>reconcileSingleElement(...)</code>:</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/4.png"/></p><p><strong>此处正式开始diff(比较)</strong>，child为旧内容fiber，element为新内容，它们的<strong>元素类型</strong>不同。</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/5.png"/></p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/6.png"/></p><p>因为类型不同，React将“删除”旧内容fiber以及其所有相邻Fiber（即给这些fiber添加副作用标签 Deletion（删除））， 并基于新内容生成新的Fiber。然后将新的Fiber设置为父Fiber的child。</p><p>到此，一个新内容为React元素的且新旧内容的元素类型不同的Diff过程已经完成。</p><p>那如果新旧内容的元素类型相同呢？</p><p>编写类似案例，我们可以得到结果</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/7.png"/></p><p><code>userFiber(...)</code>：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/8.png"/></p><p><code>userFiber(...)</code>的主要作用是基于旧内容fiber和新内容的属性（props）克隆生成一个新内容fiber，这也是所谓的fiber复用。</p><p>所以当新旧内容的元素类容相同，React会复用旧内容fiber，结合新内容属性，生成一个新的fiber。同样，将新的fiber设置位父fiber的child。</p><p>新内容为React元素的diff流程总结：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-react-element.svg"/></p><h2>新内容为文本</h2><p>当新内容为文本时，逻辑与新内容为React元素时类似：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-text.svg"/></p><h2>新内容为数组</h2><p>使用案例：</p><pre><code class="language-js">function ArrayComponent() {

  const [ showingA, setShowingA ] = useState( true ) 

  useEffect( () =&gt; {

   setTimeout( () =&gt; setShowingA( false ), 1000 )

  } )

  return showingA ? &lt;div&gt;

​    &lt;span&gt;A&lt;/span&gt;

​    &lt;span&gt;B&lt;/span&gt;

  &lt;/div&gt; : &lt;div&gt;

​    &lt;span&gt;C&lt;/span&gt;

​    D

  &lt;/div&gt;

}

ReactDOM.render( &lt;ArrayComponent/&gt;, document.getElementById(&#x27;container&#x27;) )
</code></pre><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/9.png"/></p><p>若新内容为数组，需<code>reconcileChildrenArray(...)</code>:</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/10.png"/></p><p>for循环遍历新内容数组，伪代码（用于理解）：</p><pre><code class="language-js">for ( let i = 0, oldFiber; i &lt; newArray.length; ) {

  ...

  i++

  oldFiber = oldFiber.sibling
}
</code></pre><p>遍历每个新内容数组元素时：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/11.png"/></p><p><code>updateSlot(...)</code>:</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/12.png"/></p><p>因为<code>newChild</code>的类型为<code>object</code>, 所以：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/13.png"/></p><p><code>updateElement(...)</code>:</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/14.png"/></p><p><code>updateElement(...)</code>与<code>reconcileSingleElement(...)</code>核心逻辑一致：</p><ul><li><p>若新旧内容元素类型一致，则克隆旧fiber，结合新内容生成新的fiber</p></li><li><p>若不一致，则基于新内容创建新的fiber。</p></li></ul><p>同理，<code>updateTextNode(...)</code>：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/15.png"/></p><p><code>updateTextNode(...)</code>与<code>reconcileSingleTextNode(...)</code>核心逻辑一致：</p><ul><li><p>若旧内容fiber的标签不是<code>HostText</code>,则基于新内容文本创建新的fiber</p></li><li><p>若是<code>HostText</code>, 则克隆旧fiber，结合新内容文本生成新的fiber</p></li></ul><p>在本案例中，新内容数组for循环完成后：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/16.png"/></p><p>因为新旧内容数组的长度一致，所以直接返回第一个新的fiber。然后同上，React将新的fiber设为父fiber的child。</p><p>不过若新内容数组长度与旧内容fiber及其相邻fiber的总个数不一致，React如何处理？</p><p>编写类似案例。</p><p>若新内容数组长度更短：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/17.png"/></p><p>React将删除多余的旧内容fiber的相邻fiber。</p><p>若新内容数组长度更长：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/18.png"/></p><p>React将遍历多余的新内容数组元素，基于新内容数组元素创建的新的fiber，并添加副作用标签 Placement（替换）。</p><p>新内容为数组时的diff流程总结：</p><p><img src="https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-array.svg"/></p><h2>总结</h2><p>通过React源码研究diff算法时，仅调试分析<strong>相关代码</strong>，能比较容易的得出答案。</p><p>Diff的三种情况：</p><ol><li>新内容为React元素</li><li>新内容为文本</li><li>新内容为数组</li></ol><ol><li><p>Diff时若比较结果相同，则复用旧内容Fiber，结合新内容生成新Fiber；若不同，仅通过新内容创建新fiber。</p></li><li><p>然后给旧内容fiber添加副作用替换标签，或者给旧内容fiber及其所有相邻元素添加副作用删除标签。</p></li><li><p>最后将新的（第一个）fiber设为父fiber的child。</p></li></ol><h2>参考资料</h2><ul><li><p>The how and why on React’s usage of linked list in Fiber to walk the component’s tree: <a href="https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7">https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7</a></p></li><li><p>[译]<!-- -->深入React fiber架构及源码: <a href="https://zhuanlan.zhihu.com/p/57346388">https://zhuanlan.zhihu.com/p/57346388</a></p></li><li><p>Inside Fiber: in-depth overview of the new reconciliation algorithm in React: <a href="https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e">https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e</a></p></li></ul></div></div></div></div></div><div class="markdown-body sc-VigVT emoJPF"><div><p><strong>感谢你的阅读。欢迎通过微信（扫描下方二维码）或<a href="https://github.com/Terry-Su/blogs-cn">Github</a>订阅我的博客。</strong></p>
<p><img src="https://user-images.githubusercontent.com/23733477/77869172-2459f400-7270-11ea-8a84-d5d63a426c19.png" alt="微信公众号:苏溪云的博客" /></p></div></div><div class="sc-jTzLTM hxfRZv"><div>发布时间<!-- -->: <!-- -->2020-4-9</div><div class="categoryWrapper">分类<!-- -->: <!-- -->Technology/FrontEnd/React</div><div class="reprintingNoteWrapper">作者版权所有，转载请注明出处，禁止商业转载</div></div></div></div><div class="sc-fjdhpX iTejwj"><div class="wrapper"><div><div class="sc-gZMcBi bfMZoa"><div style="box-sizing:border-box;text-align:center"><a style="color:#4169e1;text-decoration:none" href="https://github.com/Terry-Su/blogs-cn/issues/10">添加评论 (by Github Issues)</a></div><div style="padding:0"></div></div></div><div class="disqusCommentWrapper"><div><div id="disqus_thread"></div><noscript>Please enable JavaScript to view the<!-- --> <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div></div></div><div class="sc-ifAKCX jYTulZ"><span class="contentWrapper">版权 © 2017-<!-- -->2020<a class="authorLink" href="https://github.com/Terry-Su">苏溪云</a>保留所有权利</span></div></div></div></div>
    
<script type="text/javascript">

window.CURRENT_PAGE={"path":"/cn/understand-react-diff-algorithm-from-source-codes","data":{"pathnameRoot":"/cn/","authorUrl":"https://github.com/Terry-Su","locale":"zh_CN","logoTitle":"苏溪云","noteIsAutoTranslated":"本文为自动翻译。","copyright":{"left":"版权 © 2017-","center":"苏溪云","right":"保留所有权利"},"blogGithub":"https://github.com/Terry-Su/blogs-cn","id":"cn/understand-react-diff-algorithm-from-source-codes","title":"搞懂React源码系列-React Diff原理","path":"Technology/FrontEnd/React","route":"/cn/understand-react-diff-algorithm-from-source-codes","text":"\n\nconst layoutProps = {\n  \n};\nclass MDXContent extends React.Component {\n  constructor(props) {\n    super(props)\n    this.layout = null\n  }\n  render() {\n    const { components, ...props } = this.props\n\n    return <MDXTag\n             name=\"wrapper\"\n             \n             components={components}><MDXTag name=\"p\" components={components}>{`时隔2年，重新看React源码，很多以前不理解的内容现在都懂了。本文将用实际案例结合相关React源码，集中讨论React Diff原理。使用当前最新React版本：`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`16.13.1`}</MDXTag>{`。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`另外，今年将写一个“搞懂React源码系列”，把React`}<MDXTag name=\"strong\" components={components} parentName=\"p\">{`最核心内容`}</MDXTag>{`用最通俗易懂地方式讲清楚。2020年搞懂React源码系列：`}</MDXTag>\n<MDXTag name=\"ul\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`React Diff原理`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`React 调度原理`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`搭建阅读React源码环境-支持所有版本断点调试`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`React Hooks原理`}</MDXTag>\n</MDXTag>\n</MDXTag>\n<MDXTag name=\"p\" components={components}>{`在讨论Diff算法前，有必要先介绍React Fiber，因为React源码中各种实现都是基于Fiber，包括Diff算法。当然，熟悉React Fiber的朋友可跳过Fiber介绍。`}</MDXTag>\n<MDXTag name=\"h2\" components={components}>{`Fiber简介`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`Fiber并不复杂，但如果要`}<MDXTag name=\"a\" components={components} parentName=\"p\" props={{\"href\":\"https://zhuanlan.zhihu.com/p/57346388\"}}>{`全面理解`}</MDXTag>{`，还是得花好一段时间。本文主题是diff原理，所以这里仅简单介绍下Fiber。`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/fiber.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`Fiber是一个抽象的节点对象，每个对象可能有子Fiber(child)和相邻Fiber(child)和父Fiber(return),React使用链表的形式将所有Fiber节点连接，形成链表树。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`Fiber还有副作用标签(effectTag)，比如替换Placement(替换)和Deletion(删除)，用于之后更新DOM。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`值得注意的是，React diff中，除了fiber，还用到了基础的`}<MDXTag name=\"a\" components={components} parentName=\"p\" props={{\"href\":\"https://reactjs.org/docs/glossary.html#elements\"}}>{`React元素对象`}</MDXTag>{`（如： 将`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`<div>foo</div>`}</MDXTag>{`编译后生成的对象: `}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`{ type: 'div', props: { children: 'foo' } }`}</MDXTag>{` ）。`}</MDXTag>\n<MDXTag name=\"h2\" components={components}>{`Diff 过程`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`React源码中，关于diff要从`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileChildren(...)`}</MDXTag>{`说起。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`总流程：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-main.svg\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`流程图中, 显示源码中用到的函数名，省略复杂参数。“新内容”即被比较的新内容，它可能是三种类型：`}</MDXTag>\n<MDXTag name=\"ul\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`对象： React元素`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`字符串或数字： 文本`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`数组：数组元素可能是React元素或文本`}</MDXTag>\n</MDXTag>\n</MDXTag>\n<MDXTag name=\"h2\" components={components}>{`新内容为React元素`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`我们先以新内容为React元素为例，全面的调试一遍代码，将之后会重复用到的方法在此步骤中讲解，同时以一张流程图作为总结。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`案例：`}</MDXTag>\n<MDXTag name=\"pre\" components={components}><MDXTag name=\"code\" components={components} parentName=\"pre\" props={{\"className\":\"language-js\"}}>{`function SingleElementDifferentTypeChildA() { return <h1>A</h1> }\n\nfunction SingleElementDifferentTypeChildB() { return <h2>B</h2> }\n\nfunction SingleElementDifferentType() {\n\n const [ showingA, setShowingA ] = useState( true ) \n\n useEffect( () => {\n\n  setTimeout( () => setShowingA( false ), 1000 )\n\n } )\n\n return showingA ? <SingleElementDifferentTypeChildA/> : <SingleElementDifferentTypeChildB/>\n\n}\n\nReactDOM.render( <SingleElementDifferentType/>, document.getElementById('container') )\n`}</MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`从第一步`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileChildren(...)`}</MDXTag>{`开始调试代码，无需关注与diff不相关的内容，比如`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`renderExpirationTime`}</MDXTag>{`。左侧调试面板可看到对应变量的类型。`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/1.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`此处:`}</MDXTag>\n<MDXTag name=\"ul\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\"><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`workInProgress`}</MDXTag>{`: 父级Fiber`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\"><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`current.child`}</MDXTag>{`: 处于比较中的旧内容对应fiber`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\"><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`nextChildren`}</MDXTag>{`: 即处于比较中的新内容, 为React元素，其类型为对象。`}</MDXTag>\n</MDXTag>\n</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"strong\" components={components} parentName=\"p\">{`在Diff时`}</MDXTag>{`，比较中的`}<MDXTag name=\"strong\" components={components} parentName=\"p\">{`旧内容为Fiber`}</MDXTag>{`,而比较中的`}<MDXTag name=\"strong\" components={components} parentName=\"p\">{`新内容为React元素、文本或数组`}</MDXTag>{`。其实从这一步已经可以看出，React官网的`}<MDXTag name=\"a\" components={components} parentName=\"p\" props={{\"href\":\"https://reactjs.org/docs/reconciliation.html#the-diffing-algorithm\"}}>{`diff算法说明`}</MDXTag>{`和实际代码是实现差别较大。`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/2.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`因为新内容为对象，所以继续执行`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileSingleElement(...)`}</MDXTag>{`和`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`placeSingleChild(...)`}</MDXTag>{`。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`我们先看`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`placeSingleChild(...)`}</MDXTag>{`：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/3.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`placeSingleChild(...)`}</MDXTag>{`的作用很简单，给differ后的Fiber添加副作用标签：Placement（替换），表明在之后需要将旧Fiber对应的DOM元素进行替换。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`继续看 `}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileSingleElement(...)`}</MDXTag>{`:`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/4.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"strong\" components={components} parentName=\"p\">{`此处正式开始diff(比较)`}</MDXTag>{`，child为旧内容fiber，element为新内容，它们的`}<MDXTag name=\"strong\" components={components} parentName=\"p\">{`元素类型`}</MDXTag>{`不同。`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/5.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/6.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`因为类型不同，React将“删除”旧内容fiber以及其所有相邻Fiber（即给这些fiber添加副作用标签 Deletion（删除））， 并基于新内容生成新的Fiber。然后将新的Fiber设置为父Fiber的child。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`到此，一个新内容为React元素的且新旧内容的元素类型不同的Diff过程已经完成。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`那如果新旧内容的元素类型相同呢？`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`编写类似案例，我们可以得到结果`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/7.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`userFiber(...)`}</MDXTag>{`：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/8.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`userFiber(...)`}</MDXTag>{`的主要作用是基于旧内容fiber和新内容的属性（props）克隆生成一个新内容fiber，这也是所谓的fiber复用。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`所以当新旧内容的元素类容相同，React会复用旧内容fiber，结合新内容属性，生成一个新的fiber。同样，将新的fiber设置位父fiber的child。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`新内容为React元素的diff流程总结：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-react-element.svg\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"h2\" components={components}>{`新内容为文本`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`当新内容为文本时，逻辑与新内容为React元素时类似：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-text.svg\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"h2\" components={components}>{`新内容为数组`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`使用案例：`}</MDXTag>\n<MDXTag name=\"pre\" components={components}><MDXTag name=\"code\" components={components} parentName=\"pre\" props={{\"className\":\"language-js\"}}>{`function ArrayComponent() {\n\n  const [ showingA, setShowingA ] = useState( true ) \n\n  useEffect( () => {\n\n   setTimeout( () => setShowingA( false ), 1000 )\n\n  } )\n\n  return showingA ? <div>\n\n​    <span>A</span>\n\n​    <span>B</span>\n\n  </div> : <div>\n\n​    <span>C</span>\n\n​    D\n\n  </div>\n\n}\n\nReactDOM.render( <ArrayComponent/>, document.getElementById('container') )\n`}</MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/9.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`若新内容为数组，需`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileChildrenArray(...)`}</MDXTag>{`:`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/10.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`for循环遍历新内容数组，伪代码（用于理解）：`}</MDXTag>\n<MDXTag name=\"pre\" components={components}><MDXTag name=\"code\" components={components} parentName=\"pre\" props={{\"className\":\"language-js\"}}>{`for ( let i = 0, oldFiber; i < newArray.length; ) {\n\n  ...\n\n  i++\n\n  oldFiber = oldFiber.sibling\n}\n`}</MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`遍历每个新内容数组元素时：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/11.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`updateSlot(...)`}</MDXTag>{`:`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/12.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`因为`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`newChild`}</MDXTag>{`的类型为`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`object`}</MDXTag>{`, 所以：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/13.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`updateElement(...)`}</MDXTag>{`:`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/14.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`updateElement(...)`}</MDXTag>{`与`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileSingleElement(...)`}</MDXTag>{`核心逻辑一致：`}</MDXTag>\n<MDXTag name=\"ul\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`若新旧内容元素类型一致，则克隆旧fiber，结合新内容生成新的fiber`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`若不一致，则基于新内容创建新的fiber。`}</MDXTag>\n</MDXTag>\n</MDXTag>\n<MDXTag name=\"p\" components={components}>{`同理，`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`updateTextNode(...)`}</MDXTag>{`：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/15.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`updateTextNode(...)`}</MDXTag>{`与`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`reconcileSingleTextNode(...)`}</MDXTag>{`核心逻辑一致：`}</MDXTag>\n<MDXTag name=\"ul\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`若旧内容fiber的标签不是`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`HostText`}</MDXTag>{`,则基于新内容文本创建新的fiber`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`若是`}<MDXTag name=\"inlineCode\" components={components} parentName=\"p\">{`HostText`}</MDXTag>{`, 则克隆旧fiber，结合新内容文本生成新的fiber`}</MDXTag>\n</MDXTag>\n</MDXTag>\n<MDXTag name=\"p\" components={components}>{`在本案例中，新内容数组for循环完成后：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/16.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`因为新旧内容数组的长度一致，所以直接返回第一个新的fiber。然后同上，React将新的fiber设为父fiber的child。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`不过若新内容数组长度与旧内容fiber及其相邻fiber的总个数不一致，React如何处理？`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`编写类似案例。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`若新内容数组长度更短：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/17.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`React将删除多余的旧内容fiber的相邻fiber。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`若新内容数组长度更长：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/18.png\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"p\" components={components}>{`React将遍历多余的新内容数组元素，基于新内容数组元素创建的新的fiber，并添加副作用标签 Placement（替换）。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`新内容为数组时的diff流程总结：`}</MDXTag>\n<MDXTag name=\"p\" components={components}><MDXTag name=\"img\" components={components} parentName=\"p\" props={{\"src\":\"https://terry-su.github.io/assets/blogs/understand-react-diff-algorithm-from-source-codes/flowchart-array.svg\",\"alt\":null}}></MDXTag></MDXTag>\n<MDXTag name=\"h2\" components={components}>{`总结`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`通过React源码研究diff算法时，仅调试分析`}<MDXTag name=\"strong\" components={components} parentName=\"p\">{`相关代码`}</MDXTag>{`，能比较容易的得出答案。`}</MDXTag>\n<MDXTag name=\"p\" components={components}>{`Diff的三种情况：`}</MDXTag>\n<MDXTag name=\"ol\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ol\">{`新内容为React元素`}</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ol\">{`新内容为文本`}</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ol\">{`新内容为数组`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"ol\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ol\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`Diff时若比较结果相同，则复用旧内容Fiber，结合新内容生成新Fiber；若不同，仅通过新内容创建新fiber。`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ol\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`然后给旧内容fiber添加副作用替换标签，或者给旧内容fiber及其所有相邻元素添加副作用删除标签。`}</MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ol\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`最后将新的（第一个）fiber设为父fiber的child。`}</MDXTag>\n</MDXTag>\n</MDXTag>\n<MDXTag name=\"h2\" components={components}>{`参考资料`}</MDXTag>\n<MDXTag name=\"ul\" components={components}>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`The how and why on React’s usage of linked list in Fiber to walk the component’s tree: `}<MDXTag name=\"a\" components={components} parentName=\"p\" props={{\"href\":\"https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7\"}}>{`https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7`}</MDXTag></MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`[译]`}{`深入React fiber架构及源码: `}<MDXTag name=\"a\" components={components} parentName=\"p\" props={{\"href\":\"https://zhuanlan.zhihu.com/p/57346388\"}}>{`https://zhuanlan.zhihu.com/p/57346388`}</MDXTag></MDXTag>\n</MDXTag>\n<MDXTag name=\"li\" components={components} parentName=\"ul\">\n<MDXTag name=\"p\" components={components} parentName=\"li\">{`Inside Fiber: in-depth overview of the new reconciliation algorithm in React: `}<MDXTag name=\"a\" components={components} parentName=\"p\" props={{\"href\":\"https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e\"}}>{`https://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e`}</MDXTag></MDXTag>\n</MDXTag>\n</MDXTag>\n           </MDXTag>\n  }\n}\nMDXContent.isMDXComponent = true\nrender( <MDXContent /> )\n  ","postTime":1586394000000,"comment":10,"isAutoTranslated":false,"availableOtherLocales":[],"importedCodes":"","siteTitle":"搞懂React源码系列-React Diff原理(苏溪云的博客)","siteMetaDescription":" 搞懂React源码系列-React Diff原理 时隔2年，重新看React源码，很多以前不理解的内容现在都懂了。本文将用实际案例结合相关React源码，集中讨论React Diff原理。使用当前最新React版本：16.13.1。\n\n另外，今年将写... (苏溪云的博客)","categoryTitle":"分类","postTimeTitle":"发布时间","reprintingNote":"作者版权所有，转载请注明出处，禁止商业转载","endingWords":"article.endingWords","githubCommentBase":"https://api.github.com/repos/terry-su/blogs-cn/issues/","githubIssuePageBase":"https://github.com/Terry-Su/blogs-cn/issues/","remarkDisqusComment":"https://terrysu.disqus.com/embed.js","texts":{"siteTitle":"苏溪云的博客","siteMetaDescription":"苏溪云的原创前端技术博客 4年前端 分享主流前端技术 JavaScript ReactJS","categoryNewest":"最近发布","navArticles":"所有文章","navAbout":"关于作者"},"articleTexts":{"endingWordsExtra":"**感谢你的阅读。欢迎通过微信（扫描下方二维码）或[Github](https://github.com/Terry-Su/blogs-cn)订阅我的博客。**\n\n ![微信公众号:苏溪云的博客](https://user-images.githubusercontent.com/23733477/77869172-2459f400-7270-11ea-8a84-d5d63a426c19.png)","qrcodeImageUrl":"","reprintingNote":"作者版权所有，转载请注明出处，禁止商业转载","category":"分类","postTime":"发布时间","githubIssuePageBase":"https://github.com/Terry-Su/blogs-cn/issues/","githubCommentBase":"https://api.github.com/repos/terry-su/blogs-cn/issues/","commentOnGithub":"添加评论 (by Github Issues)"},"markedEndingWordsExtra":"<p><strong>感谢你的阅读。欢迎通过微信（扫描下方二维码）或<a href=\"https://github.com/Terry-Su/blogs-cn\">Github</a>订阅我的博客。</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/23733477/77869172-2459f400-7270-11ea-8a84-d5d63a426c19.png\" alt=\"微信公众号:苏溪云的博客\" /></p>"}}

</script>

    
      <script type="text/javascript" src="https://unpkg.com/@babel/standalone@7.4.3/babel.min.js"></script>
      <script crossorigin type="text/javascript" src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
      <script crossorigin type="text/javascript" src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
      <script src="https://unpkg.com/styled-components@4.0.0/dist/styled-components.min.js"></script>
      
    <script src="/bundle.js"></script>
      <script src="/bundle.js"></script>
  </body>
</html>